{% extends "base.html" %}

{% block title %}{% if workout %}Edit{% else %}New{% endif %} Strength Workout - Fitness Leveling{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Form Section -->
        <div class="lg:col-span-2">
            <div class="bg-dark-surface rounded-xl shadow-sm p-6">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-100">{% if workout %}Edit{% else %}Log{% endif %} Workout</h1>
                </div>
                
                <form id="strength-workout-form" method="POST" action="{{ url_for('workout.edit', id=workout.id) if workout else url_for('workout.new_strength') }}" class="space-y-6">
                    <!-- Basic Workout Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-300">Workout Name</label>
                            <input type="text" id="name" name="name" required
                                class="mt-1 block w-full bg-dark-hover border-gray-700 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-100 placeholder-gray-400"
                                placeholder="e.g., Upper Body Day, Leg Day"
                                value="{{ workout.name if workout else '' }}">
                        </div>
                        <div>
                            <label for="duration" class="block text-sm font-medium text-gray-300">Duration (minutes)</label>
                            <input type="number" id="duration" name="duration" required min="1"
                                class="mt-1 block w-full bg-dark-hover border-gray-700 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-100"
                                value="{{ workout.duration if workout else '' }}">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="subtype" class="block text-sm font-medium text-gray-300">Workout Type</label>
                            <select id="subtype" name="subtype" 
                                class="mt-1 block w-full bg-dark-hover border-gray-700 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-100">
                                <option value="strength_upper" {% if workout and workout.subtype == 'strength_upper' %}selected{% endif %}>Upper Body</option>
                                <option value="strength_lower" {% if workout and workout.subtype == 'strength_lower' %}selected{% endif %}>Lower Body</option>
                                <option value="strength_push" {% if workout and workout.subtype == 'strength_push' %}selected{% endif %}>Push Workout</option>
                                <option value="strength_pull" {% if workout and workout.subtype == 'strength_pull' %}selected{% endif %}>Pull Workout</option>
                                <option value="strength_full" {% if not workout or workout.subtype == 'strength_full' %}selected{% endif %}>Full Body</option>
                                <option value="strength_other" {% if workout and workout.subtype == 'strength_other' %}selected{% endif %}>Other Strength</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="intensity" class="block text-sm font-medium text-gray-300">Overall Intensity (1-10)</label>
                            <input type="range" id="intensity" name="intensity" min="1" max="10" 
                                value="{{ workout.intensity if workout else 5 }}"
                                class="mt-1 block w-full bg-dark-hover accent-blue-500"
                                oninput="document.getElementById('intensity-value').textContent = this.value">
                            <div class="flex justify-between text-xs text-gray-400 mt-1">
                                <span>Easy (1)</span>
                                <span id="intensity-value">{{ workout.intensity if workout else 5 }}</span>
                                <span>Max Effort (10)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Exercises Section -->
                    <div class="border-t border-gray-700 pt-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-medium text-gray-100">Exercises</h2>
                            <button type="button" id="add-exercise-btn"
                                class="inline-flex items-center px-3 h-8 border border-transparent text-xs font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Add Exercise
                            </button>
                        </div>
                        
                        <div id="exercises-container" class="space-y-6">
                            <!-- Exercise cards will be added here dynamically -->
                            <div class="text-center py-10 text-gray-400 italic text-sm" id="no-exercises-message">
                                No exercises added yet. Click "Add Exercise" to start building your workout.
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-300">Workout Notes</label>
                        <textarea id="notes" name="notes" rows="3"
                            class="mt-1 block w-full bg-dark-hover border-gray-700 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-100 placeholder-gray-400"
                            placeholder="How did it feel? Any achievements or personal records?">{{ workout.notes if workout else '' }}</textarea>
                    </div>

                    <!-- Hidden field to store exercise data as JSON -->
                    <input type="hidden" id="exercises-data" name="exercises_data" value="[]">

                    <!-- Submit Button -->
                    <div class="flex justify-end space-x-4">
                        <a href="{{ url_for('workout.view', workout_id=workout.id) if workout else url_for('workout.index') }}"
                            class="inline-flex items-center justify-center px-4 h-10 border border-gray-700 text-sm font-medium rounded-lg text-gray-300 bg-dark-hover hover:bg-dark-surface transition-colors">
                            Cancel
                        </a>
                        <button type="submit" id="submit-btn"
                            class="inline-flex items-center justify-center px-4 h-10 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 transition-colors"
                            disabled>
                            {% if workout %}Save Changes{% else %}Log Workout{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Previous Workout Section (Sidebar) -->
        <div class="lg:col-span-1">
            <div class="bg-dark-surface rounded-xl shadow-sm p-6 sticky top-6">
                <div id="no-previous-workout" class="hidden mt-4 text-gray-400">
                    No previous workout found for this type
                </div>
                <div id="previous-workout-details" class="hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-100">Previous Workout</h3>
                    <div class="bg-gray-800/50 rounded-lg p-4">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <span class="text-gray-400">Date:</span>
                                <span id="prev-workout-date" class="text-gray-200 ml-2"></span>
                            </div>
                            <div>
                                <span class="text-gray-400">Duration:</span>
                                <span id="prev-workout-duration" class="text-gray-200 ml-2"></span>
                            </div>
                            <div>
                                <span class="text-gray-400">Intensity:</span>
                                <span id="prev-workout-intensity" class="text-gray-200 ml-2"></span>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-gray-300 font-medium mb-2">Exercises:</h4>
                            <div id="prev-workout-exercises" class="space-y-3">
                                <!-- Exercise details will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Exercise Template (hidden) -->
<template id="exercise-template">
    <div class="exercise-card bg-dark-hover rounded-lg p-4 relative" data-exercise-id="%EXERCISE_ID%">
        <button type="button" class="remove-exercise-btn absolute top-3 right-3 text-gray-400 hover:text-red-400">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-300 mb-1">Exercise Name</label>
            <div class="flex">
                <input type="text" class="exercise-name block w-full bg-dark-surface border-gray-700 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-100" 
                    placeholder="e.g., Bench Press" list="exercise-options" required>
                <button type="button" class="add-set-btn ml-2 px-3 py-1 bg-blue-600/30 hover:bg-blue-600/50 text-blue-300 rounded-md text-xs whitespace-nowrap">
                    <svg class="w-4 h-4 inline -mt-0.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add Set
                </button>
            </div>
            
            <!-- Exercise History and PRs -->
            <div class="exercise-history mt-3 text-xs space-y-2">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <div class="sets-container">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-gray-300">
                    <thead>
                        <tr>
                            <th class="px-2 py-2 text-left">Set</th>
                            <th class="px-2 py-2 text-left">Weight (kg)</th>
                            <th class="px-2 py-2 text-left">Reps</th>
                            <th class="px-2 py-2 text-left">Notes</th>
                            <th class="px-2 py-2 w-10"></th>
                        </tr>
                    </thead>
                    <tbody class="sets-table-body divide-y divide-gray-800">
                        <!-- Sets will be added here dynamically -->
                    </tbody>
                </table>
            </div>
            <div class="no-sets-message text-center py-3 text-gray-400 italic text-xs">
                No sets added yet. Click "Add Set" to add your first set.
            </div>
        </div>
    </div>
</template>

<!-- Set Row Template (hidden) -->
<template id="set-row-template">
    <tr class="set-row hover:bg-dark-surface" data-set-number="%SET_NUMBER%">
        <td class="px-2 py-2">
            <span class="set-number">%SET_NUMBER%</span>
        </td>
        <td class="px-2 py-2">
            <input type="number" class="set-weight block w-full bg-dark-surface border-gray-700 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-100" 
                placeholder="0" min="0" step="0.5">
        </td>
        <td class="px-2 py-2">
            <input type="number" class="set-reps block w-full bg-dark-surface border-gray-700 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-100" 
                placeholder="0" min="1" required>
        </td>
        <td class="px-2 py-2">
            <input type="text" class="set-notes block w-full bg-dark-surface border-gray-700 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-100" 
                placeholder="Optional notes">
        </td>
        <td class="px-2 py-2">
            <button type="button" class="remove-set-btn text-gray-400 hover:text-red-400">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </td>
    </tr>
</template>

<datalist id="exercise-options">
    {% for exercise in exercise_options %}
    <option value="{{ exercise }}">
    {% endfor %}
</datalist>

{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    let exerciseCounter = 0;
    const exercisesData = [];
    
    // Initialize data from server
    const serverData = {
        exerciseHistory: {{ exercise_history|default({})|tojson|safe }},
        workoutHistory: {{ workout_history|default({})|tojson|safe }},
        initialExercises: {{ initial_exercises|default('[]')|safe }}
    };
    
    // DOM Elements
    const workoutForm = document.getElementById('strength-workout-form');
    const submitBtn = document.getElementById('submit-btn');
    const exercisesContainer = document.getElementById('exercises-container');
    const noExercisesMessage = document.getElementById('no-exercises-message');
    const exercisesDataInput = document.getElementById('exercises-data');
    const nameInput = document.getElementById('name');
    const durationInput = document.getElementById('duration');
    const subtypeSelect = document.getElementById('subtype');
    const workoutHistoryDiv = document.getElementById('workout-history');
    const addExerciseBtn = document.getElementById('add-exercise-btn');
    const exerciseTemplate = document.getElementById('exercise-template');
    const setRowTemplate = document.getElementById('set-row-template');
    
    // Function to initialize existing exercises
    function initializeExistingExercises() {
        if (serverData.initialExercises && serverData.initialExercises.length > 0) {
            console.log('Initializing form with existing exercises:', serverData.initialExercises);
            noExercisesMessage.style.display = 'none';
            
            // Parse initialExercises if it's a string
            let exercises = typeof serverData.initialExercises === 'string' 
                ? JSON.parse(serverData.initialExercises) 
                : serverData.initialExercises;
            
            console.log('Parsed exercises:', exercises);
            
            // Add each exercise from the initial data
            exercises.forEach(exerciseData => {
                console.log('Processing exercise:', exerciseData);
                const exerciseCard = addExercise();
                const exerciseNameInput = exerciseCard.querySelector('.exercise-name');
                exerciseNameInput.value = exerciseData.name;
                
                // Remove the automatically added first set
                const setsTableBody = exerciseCard.querySelector('.sets-table-body');
                setsTableBody.innerHTML = '';
                
                // Add sets for this exercise
                if (exerciseData.sets && exerciseData.sets.length > 0) {
                    exerciseData.sets.forEach(setData => {
                        console.log('Processing set:', setData);
                        const setNumber = setData.set_number || 1;
                        
                        // Create row and add HTML
                        const setRow = document.createElement('tr');
                        setRow.classList.add('set-row');
                        setRow.dataset.setNumber = setNumber;
                        
                        // Create the row content
                        setRow.innerHTML = `
                            <td class="px-2 py-2">
                                <span class="set-number">${setNumber}</span>
                            </td>
                            <td class="px-2 py-2">
                                <input type="number" class="set-weight block w-full bg-dark-surface border-gray-700 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-100" 
                                    placeholder="0" min="0" step="0.5" value="${setData.weight || ''}">
                            </td>
                            <td class="px-2 py-2">
                                <input type="number" class="set-reps block w-full bg-dark-surface border-gray-700 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-100" 
                                    placeholder="0" min="1" required value="${setData.reps || ''}">
                            </td>
                            <td class="px-2 py-2">
                                <input type="text" class="set-notes block w-full bg-dark-surface border-gray-700 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-100" 
                                    placeholder="Optional notes" value="${setData.notes || ''}">
                            </td>
                            <td class="px-2 py-2">
                                <button type="button" class="remove-set-btn text-gray-400 hover:text-red-400">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </td>
                        `;
                        
                        // Add set to DOM
                        setsTableBody.appendChild(setRow);
                        
                        // Add event listeners
                        const removeSetBtn = setRow.querySelector('.remove-set-btn');
                        const weightInput = setRow.querySelector('.set-weight');
                        const repsInput = setRow.querySelector('.set-reps');
                        const notesInput = setRow.querySelector('.set-notes');
                        
                        removeSetBtn.addEventListener('click', () => removeSet(exerciseCard.dataset.exerciseId, setNumber));
                        weightInput.addEventListener('change', updateExercisesData);
                        repsInput.addEventListener('change', updateExercisesData);
                        notesInput.addEventListener('change', updateExercisesData);
                    });
                }
                
                // Hide no sets message if we added sets
                if (exerciseData.sets && exerciseData.sets.length > 0) {
                    exerciseCard.querySelector('.no-sets-message').style.display = 'none';
                }
                
                // Update exercise history
                updateExerciseHistory(exerciseCard, exerciseData.name);
            });
            
            // Update the exercises data
            updateExercisesData();
        } else {
            console.log('No initial exercises found');
        }
    }
    
    // Initialize form
    document.addEventListener('DOMContentLoaded', function() {
        // Add event listeners
        workoutForm.addEventListener('submit', prepareFormSubmission);
        addExerciseBtn.addEventListener('click', addExercise);
        subtypeSelect.addEventListener('change', updatePreviousWorkout);
        nameInput.addEventListener('input', updateSubmitButtonState);
        durationInput.addEventListener('input', updateSubmitButtonState);
        
        // Initialize form with existing data if editing
        initializeExistingExercises();
        
        // Show previous workout info
        updatePreviousWorkout();
        
        // Enable submit button if form is valid
        updateSubmitButtonState();
    });
    
    // Function to format date
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
        });
    }
    
    // Function to update workout history display
    function updateWorkoutHistory() {
        const selectedType = subtypeSelect.value;
        const history = serverData.workoutHistory[selectedType];
        
        if (!history) {
            workoutHistoryDiv.innerHTML = '<p class="text-gray-400 italic mt-2">No previous workouts of this type</p>';
            return;
        }
        
        let html = `
            <div class="bg-blue-900/20 p-2 rounded text-blue-200 mt-2">
                <div class="font-medium mb-1">Workout Stats:</div>
                <div class="grid grid-cols-2 gap-x-4 gap-y-1">
                    <div>Total Volume: ${Math.round(history.stats.total_volume)}kg</div>
                    <div>Max Duration: ${history.stats.max_duration}min</div>
                    <div>Avg Intensity: ${history.stats.avg_intensity}/10</div>
                </div>
            </div>
        `;
        
        if (history.stats.common_exercises.length > 0) {
            html += `
                <div class="mt-2">
                    <div class="text-gray-400 text-xs">Common exercises:</div>
                    <div class="flex flex-wrap gap-1 mt-1">
                        ${history.stats.common_exercises.map(([name, count]) => `
                            <span class="inline-flex items-center px-2 py-1 rounded-md bg-blue-900/20 text-blue-200">
                                ${name}
                            </span>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        if (history.last_workout) {
            const last = history.last_workout;
            html += `
                <div class="mt-2">
                    <div class="text-gray-400">Last workout (${formatDate(last.created_at)}):</div>
                    <div class="text-xs mt-1">
                        <div class="text-gray-200">${last.name}</div>
                        <div class="text-gray-400">
                            ${last.duration}min at intensity ${last.intensity}/10
                        </div>
                        <div class="mt-1">
                            ${last.exercises.map(ex => `
                                <div class="text-gray-300">
                                    ${ex.name}: ${ex.total_sets} sets
                                    ${ex.max_weight ? ` (max ${ex.max_weight}kg × ${ex.max_reps})` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        workoutHistoryDiv.innerHTML = html;
    }
    
    // Function to update exercise history display
    function updateExerciseHistory(exerciseCard, exerciseName) {
        const historyDiv = exerciseCard.querySelector('.exercise-history');
        const history = serverData.exerciseHistory[exerciseName];
        
        if (!history) {
            historyDiv.innerHTML = '<p class="text-gray-400 italic">No previous history</p>';
            return;
        }
        
        // Show PRs
        const prs = history.prs;
        let html = `
            <div class="bg-blue-900/20 p-2 rounded text-blue-200">
                <div class="font-medium">Personal Records:</div>
                <div class="grid grid-cols-3 gap-2 mt-1">
                    <div>Max Weight: ${prs.max_weight}kg</div>
                    <div>Max Reps: ${prs.max_reps}</div>
                    <div>Max Volume: ${prs.max_volume}kg</div>
                </div>
            </div>
        `;
        
        // Show last workout
        if (history.last_workout) {
            html += `
                <div class="text-gray-400 mt-2">
                    Last done: ${formatDate(history.last_workout)}
                </div>
            `;
        }
        
        // Show last workout sets
        if (history.history && history.history.length > 0) {
            const lastWorkout = history.history[0];
            html += `
                <div class="mt-2">
                    <div class="text-gray-400 mb-1">Last workout sets:</div>
                    <div class="space-y-1">
                        ${lastWorkout.sets.map(set => `
                            <div class="text-xs text-gray-300">
                                Set ${set.set_number}: ${set.weight}kg × ${set.reps} reps
                                ${set.notes ? `<span class="text-gray-400">(${set.notes})</span>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        historyDiv.innerHTML = html;
        updateExercisesData();
    }
    
    // Function to create a new exercise card
    function createExerciseCard() {
        const template = document.getElementById('exercise-template');
        const exerciseCard = template.content.cloneNode(true);
        
        // Set unique ID
        exerciseCard.querySelector('.exercise-card').dataset.exerciseId = `exercise-${exerciseCounter++}`;
        
        // Add event listeners
        const exerciseNameInput = exerciseCard.querySelector('.exercise-name');
        exerciseNameInput.addEventListener('change', function() {
            updateExerciseHistory(this.closest('.exercise-card'), this.value);
            updateExercisesData();
        });
        
        // Add remove button listener
        exerciseCard.querySelector('.remove-exercise-btn').addEventListener('click', function() {
            this.closest('.exercise-card').remove();
            updateExercisesData();
        });
        
        // Add set button listener
        exerciseCard.querySelector('.add-set-btn').addEventListener('click', function() {
            addSetToExercise(this.closest('.exercise-card'));
        });
        
        return exerciseCard;
    }
    
    // Add a new exercise card
    function addExercise() {
        exerciseCounter++;
        const exerciseId = exerciseCounter;
        
        // Clone template and replace placeholders
        const exerciseHTML = exerciseTemplate.innerHTML.replace(/%EXERCISE_ID%/g, exerciseId);
        
        // Create container and add HTML
        const exerciseElement = document.createElement('div');
        exerciseElement.innerHTML = exerciseHTML;
        exerciseElement.dataset.exerciseId = exerciseId;
        exerciseElement.className = 'exercise-card-container';
        
        // Add exercise to DOM
        exercisesContainer.appendChild(exerciseElement);
        noExercisesMessage.style.display = 'none';
        
        // Add event listeners
        const exerciseCard = exerciseElement.querySelector('.exercise-card');
        const removeExerciseBtn = exerciseCard.querySelector('.remove-exercise-btn');
        const addSetBtn = exerciseCard.querySelector('.add-set-btn');
        const exerciseNameInput = exerciseCard.querySelector('.exercise-name');
        
        removeExerciseBtn.addEventListener('click', () => removeExercise(exerciseId));
        addSetBtn.addEventListener('click', () => addSet(exerciseId));
        exerciseNameInput.addEventListener('change', () => {
            updateExerciseHistory(exerciseCard, exerciseNameInput.value);
            updateExercisesData();
        });
        
        // Add first set automatically
        addSet(exerciseId);
        
        // Add to data structure
        exercisesData.push({
            id: exerciseId,
            name: '',
            sets: []
        });
        
        updateExercisesData();
        updateSubmitButtonState();
        
        // Return the exercise card for chaining
        return exerciseCard;
    }
    
    // Remove an exercise card
    function removeExercise(exerciseId) {
        const exerciseElement = document.querySelector(`.exercise-card-container[data-exercise-id="${exerciseId}"]`);
        if (exerciseElement) {
            exerciseElement.remove();
            
            // Remove from data structure
            const index = exercisesData.findIndex(ex => ex.id === exerciseId);
            if (index !== -1) {
                exercisesData.splice(index, 1);
                updateExercisesData();
            }
            
            // Show message if no exercises remain
            if (exercisesContainer.querySelectorAll('.exercise-card-container').length === 0) {
                noExercisesMessage.style.display = 'block';
            }
            
            updateSubmitButtonState();
        }
    }
    
    // Add a set to an exercise
    function addSet(exerciseId) {
        const exerciseCard = document.querySelector(`.exercise-card[data-exercise-id="${exerciseId}"]`);
        const setsTableBody = exerciseCard.querySelector('.sets-table-body');
        const noSetsMessage = exerciseCard.querySelector('.no-sets-message');
        
        // Count existing sets to determine the new set number
        const existingSets = setsTableBody.querySelectorAll('.set-row');
        const setNumber = existingSets.length + 1;
        
        // Clone template and replace placeholders
        const setRowHTML = setRowTemplate.innerHTML.replace(/%SET_NUMBER%/g, setNumber);
        
        // Create row and add HTML
        const setRow = document.createElement('tr');
        setRow.innerHTML = setRowHTML;
        setRow.classList.add('set-row');
        setRow.dataset.setNumber = setNumber;
        
        // Add set to DOM
        setsTableBody.appendChild(setRow);
        noSetsMessage.style.display = 'none';
        
        // Add event listeners
        const removeSetBtn = setRow.querySelector('.remove-set-btn');
        const weightInput = setRow.querySelector('.set-weight');
        const repsInput = setRow.querySelector('.set-reps');
        const notesInput = setRow.querySelector('.set-notes');
        
        removeSetBtn.addEventListener('click', () => removeSet(exerciseId, setNumber));
        weightInput.addEventListener('change', updateExercisesData);
        repsInput.addEventListener('change', updateExercisesData);
        notesInput.addEventListener('change', updateExercisesData);
        
        // Add to data structure
        const exerciseIndex = exercisesData.findIndex(ex => ex.id === exerciseId);
        if (exerciseIndex !== -1) {
            exercisesData[exerciseIndex].sets.push({
                setNumber: setNumber,
                weight: '',
                reps: '',
                notes: ''
            });
        }
        
        updateExercisesData();
    }
    
    // Remove a set from an exercise
    function removeSet(exerciseId, setNumber) {
        const exerciseCard = document.querySelector(`.exercise-card[data-exercise-id="${exerciseId}"]`);
        const setRow = exerciseCard.querySelector(`.set-row[data-set-number="${setNumber}"]`);
        
        if (setRow) {
            setRow.remove();
            
            // Remove from data structure
            const exerciseIndex = exercisesData.findIndex(ex => ex.id === exerciseId);
            if (exerciseIndex !== -1) {
                const setIndex = exercisesData[exerciseIndex].sets.findIndex(set => set.setNumber === parseInt(setNumber));
                if (setIndex !== -1) {
                    exercisesData[exerciseIndex].sets.splice(setIndex, 1);
                }
            }
            
            // Renumber remaining sets
            const remainingSets = exerciseCard.querySelectorAll('.set-row');
            remainingSets.forEach((row, index) => {
                const newSetNumber = index + 1;
                row.dataset.setNumber = newSetNumber;
                row.querySelector('.set-number').textContent = newSetNumber;
                
                // Update set number in data structure
                if (exerciseIndex !== -1 && index < exercisesData[exerciseIndex].sets.length) {
                    exercisesData[exerciseIndex].sets[index].setNumber = newSetNumber;
                }
            });
            
            // Show message if no sets remain
            if (remainingSets.length === 0) {
                exerciseCard.querySelector('.no-sets-message').style.display = 'block';
            }
            
            updateExercisesData();
        }
    }
    
    // Update the data structure with current values
    function updateExercisesData() {
        const exerciseCards = document.querySelectorAll('.exercise-card');
        
        exerciseCards.forEach(card => {
            const exerciseId = parseInt(card.dataset.exerciseId);
            const exerciseName = card.querySelector('.exercise-name').value;
            const exerciseIndex = exercisesData.findIndex(ex => ex.id === exerciseId);
            
            if (exerciseIndex !== -1) {
                exercisesData[exerciseIndex].name = exerciseName;
                exercisesData[exerciseIndex].sets = [];  // Reset sets array
                
                // Update set data
                const setRows = Array.from(card.querySelectorAll('.set-row'));
                // Sort by set number to ensure correct order
                setRows.sort((a, b) => parseInt(a.dataset.setNumber) - parseInt(b.dataset.setNumber));
                
                // Rebuild sets array with sequential numbers starting at 1
                setRows.forEach((row, index) => {
                    const setNumber = index + 1;  // Ensure sequential numbering
                    const weight = row.querySelector('.set-weight').value;
                    const reps = row.querySelector('.set-reps').value;
                    const notes = row.querySelector('.set-notes').value;
                    
                    exercisesData[exerciseIndex].sets.push({
                        setNumber: setNumber,
                        weight: weight,
                        reps: reps,
                        notes: notes
                    });
                    
                    // Update the displayed set number
                    row.dataset.setNumber = setNumber;
                    row.querySelector('.set-number').textContent = setNumber;
                });
            }
        });
        
        // Update hidden input with JSON data
        const cleanData = exercisesData.map(exercise => ({
            name: exercise.name,
            sets: exercise.sets.map(set => ({
                set_number: set.setNumber,  // Ensure set_number is included
                reps: set.reps,
                weight: set.weight,
                notes: set.notes
            }))
        }));
        
        exercisesDataInput.value = JSON.stringify(cleanData);
        updateSubmitButtonState();
    }
    
    // Enable/disable submit button based on form validity
    function updateSubmitButtonState() {
        const workoutName = nameInput.value.trim();
        const duration = parseInt(durationInput.value);
        const hasExercises = exercisesContainer.querySelectorAll('.exercise-card').length > 0;
        const hasValidExercises = Array.from(exercisesContainer.querySelectorAll('.exercise-name')).every(input => input.value.trim() !== '');
        const hasValidSets = Array.from(exercisesContainer.querySelectorAll('.exercise-card')).every(card => {
            const sets = card.querySelectorAll('.set-row');
            return sets.length > 0 && Array.from(sets).every(set => {
                const reps = parseInt(set.querySelector('.set-reps').value);
                return !isNaN(reps) && reps > 0;
            });
        });
        
        const isValid = workoutName && duration > 0 && hasExercises && hasValidExercises && hasValidSets;
        submitBtn.disabled = !isValid;
        
        // Update button appearance
        if (isValid) {
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            submitBtn.classList.add('hover:bg-blue-700');
        } else {
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            submitBtn.classList.remove('hover:bg-blue-700');
        }
    }
    
    // Prepare form data before submission
    function prepareFormSubmission(e) {
        updateExercisesData();
        
        const workoutName = nameInput.value.trim();
        const duration = parseInt(durationInput.value);
        const hasExercises = exercisesContainer.querySelectorAll('.exercise-card').length > 0;
        const hasValidExercises = Array.from(exercisesContainer.querySelectorAll('.exercise-name')).every(input => input.value.trim() !== '');
        const hasValidSets = Array.from(exercisesContainer.querySelectorAll('.exercise-card')).every(card => {
            const sets = card.querySelectorAll('.set-row');
            return sets.length > 0 && Array.from(sets).every(set => {
                const reps = parseInt(set.querySelector('.set-reps').value);
                return !isNaN(reps) && reps > 0;
            });
        });
        
        if (!workoutName || duration <= 0 || !hasExercises || !hasValidExercises || !hasValidSets) {
            e.preventDefault();
            let message = 'Please fix the following issues:\n';
            if (!workoutName) message += '- Workout name is required\n';
            if (duration <= 0) message += '- Duration must be greater than 0\n';
            if (!hasExercises) message += '- Add at least one exercise\n';
            if (!hasValidExercises) message += '- All exercises must have names\n';
            if (!hasValidSets) message += '- All exercises must have at least one set with valid reps\n';
            alert(message);
            return;
        }
        
        // Enable submit button before form submission
        submitBtn.disabled = false;
    }
    
    // Function to update previous workout info
    function updatePreviousWorkout() {
        const workoutType = document.getElementById('subtype').value;
        console.log('\nDEBUG: Updating previous workout display');
        console.log('Workout type selected:', workoutType);
        console.log('Available workout history:', JSON.stringify(serverData.workoutHistory, null, 2));
        
        const history = serverData.workoutHistory[workoutType];
        console.log('History found for this type:', history ? 'yes' : 'no');
        if (history) {
            console.log('Last workout:', history.last_workout);
        }
        
        const noPrevWorkout = document.getElementById('no-previous-workout');
        const prevWorkoutDetails = document.getElementById('previous-workout-details');
        
        if (!history || !history.last_workout) {
            console.log('No history or last workout found - showing "no previous workout" message');
            noPrevWorkout.classList.remove('hidden');
            prevWorkoutDetails.classList.add('hidden');
            return;
        }
        
        const workout = history.last_workout;
        console.log('Displaying workout:', workout);
        
        // Update the workout details
        document.getElementById('prev-workout-date').textContent = formatDate(workout.created_at);
        document.getElementById('prev-workout-duration').textContent = `${workout.duration} min`;
        document.getElementById('prev-workout-intensity').textContent = `${workout.intensity}/10`;
        
        // Update exercises
        const exercisesList = document.getElementById('prev-workout-exercises');
        exercisesList.innerHTML = '';
        
        workout.exercises.forEach(exercise => {
            console.log('Adding exercise to display:', exercise);
            const exerciseDiv = document.createElement('div');
            exerciseDiv.className = 'bg-gray-700 rounded p-3';
            
            // Exercise name header
            const nameHeader = document.createElement('h5');
            nameHeader.className = 'text-gray-200 font-semibold mb-2';
            nameHeader.textContent = exercise.name;
            exerciseDiv.appendChild(nameHeader);
            
            // Create table for sets
            if (exercise.sets && exercise.sets.length > 0) {
                const table = document.createElement('table');
                table.className = 'w-full text-sm';
                
                // Table header
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr class="text-gray-400">
                        <th class="text-left py-1">Set</th>
                        <th class="text-left py-1">Weight (kg)</th>
                        <th class="text-left py-1">Reps</th>
                        <th class="text-left py-1">Notes</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                // Table body
                const tbody = document.createElement('tbody');
                exercise.sets.forEach(set => {
                    const tr = document.createElement('tr');
                    tr.className = 'text-gray-300';
                    tr.innerHTML = `
                        <td class="py-1">${set.set_number}</td>
                        <td class="py-1">${set.weight || '-'}</td>
                        <td class="py-1">${set.reps || '-'}</td>
                        <td class="py-1">${set.notes || ''}</td>
                    `;
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                exerciseDiv.appendChild(table);
            }
            
            exercisesList.appendChild(exerciseDiv);
        });
        
        noPrevWorkout.classList.add('hidden');
        prevWorkoutDetails.classList.remove('hidden');
        console.log('Previous workout display updated successfully');
    }
</script>
{% endblock %} 