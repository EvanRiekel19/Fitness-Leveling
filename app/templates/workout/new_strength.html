{% extends "base.html" %}

{% block title %}Detailed Strength Workout - Fitness Leveling{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <div class="bg-dark-surface rounded-xl shadow-sm p-6">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-100">Log Workout</h1>
        </div>
        
        <form id="strength-workout-form" method="POST" class="space-y-6">
            <!-- Basic Workout Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-300">Workout Name</label>
                    <input type="text" id="name" name="name" required
                        class="mt-1 block w-full bg-dark-hover border-gray-700 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-100 placeholder-gray-400"
                        placeholder="e.g., Upper Body Day, Leg Day">
                </div>
                <div>
                    <label for="duration" class="block text-sm font-medium text-gray-300">Duration (minutes)</label>
                    <input type="number" id="duration" name="duration" required min="1"
                        class="mt-1 block w-full bg-dark-hover border-gray-700 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-100">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="subtype" class="block text-sm font-medium text-gray-300">Workout Type</label>
                    <select id="subtype" name="subtype" 
                        class="mt-1 block w-full bg-dark-hover border-gray-700 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-100">
                        <option value="strength_upper">Upper Body</option>
                        <option value="strength_lower">Lower Body</option>
                        <option value="strength_push">Push Workout</option>
                        <option value="strength_pull">Pull Workout</option>
                        <option value="strength_full" selected>Full Body</option>
                        <option value="strength_other">Other Strength</option>
                    </select>
                    
                    <!-- Previous Workout Info -->
                    <div id="previous-workout-info" class="mt-4 p-3 bg-dark-surface rounded-lg border border-gray-700">
                        <h3 class="text-sm font-medium text-gray-300 mb-2">Previous Workout</h3>
                        <div id="no-previous-workout" class="text-xs text-gray-400 italic">
                            No previous workouts of this type
                        </div>
                        <div id="previous-workout-details" class="hidden">
                            <div class="grid grid-cols-2 gap-2 text-xs mb-2">
                                <div>
                                    <span class="text-gray-400">Date:</span>
                                    <span class="text-gray-200" id="prev-workout-date"></span>
                                </div>
                                <div>
                                    <span class="text-gray-400">Duration:</span>
                                    <span class="text-gray-200" id="prev-workout-duration"></span>
                                </div>
                                <div>
                                    <span class="text-gray-400">Intensity:</span>
                                    <span class="text-gray-200" id="prev-workout-intensity"></span>
                                </div>
                            </div>
                            <div class="text-xs">
                                <div class="text-gray-400 mb-1">Exercises:</div>
                                <ul class="space-y-1" id="prev-workout-exercises">
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label for="intensity" class="block text-sm font-medium text-gray-300">Overall Intensity (1-10)</label>
                    <input type="range" id="intensity" name="intensity" min="1" max="10" value="5"
                        class="mt-1 block w-full bg-dark-hover accent-blue-500"
                        oninput="document.getElementById('intensity-value').textContent = this.value">
                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                        <span>Easy (1)</span>
                        <span id="intensity-value">5</span>
                        <span>Max Effort (10)</span>
                    </div>
                </div>
            </div>

            <!-- Exercises Section -->
            <div class="border-t border-gray-700 pt-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-medium text-gray-100">Exercises</h2>
                    <button type="button" id="add-exercise-btn"
                        class="inline-flex items-center px-3 h-8 border border-transparent text-xs font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Add Exercise
                    </button>
                </div>
                
                <div id="exercises-container" class="space-y-6">
                    <!-- Exercise cards will be added here dynamically -->
                    <div class="text-center py-10 text-gray-400 italic text-sm" id="no-exercises-message">
                        No exercises added yet. Click "Add Exercise" to start building your workout.
                    </div>
                </div>
            </div>

            <!-- Notes -->
            <div>
                <label for="notes" class="block text-sm font-medium text-gray-300">Workout Notes</label>
                <textarea id="notes" name="notes" rows="3"
                    class="mt-1 block w-full bg-dark-hover border-gray-700 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-100 placeholder-gray-400"
                    placeholder="How did it feel? Any achievements or personal records?"></textarea>
            </div>

            <!-- Hidden field to store exercise data as JSON -->
            <input type="hidden" id="exercises-data" name="exercises_data" value="[]">

            <!-- Submit Button -->
            <div class="flex justify-end space-x-4">
                <a href="{{ url_for('workout.index') }}"
                    class="inline-flex items-center justify-center px-4 h-10 border border-gray-700 text-sm font-medium rounded-lg text-gray-300 bg-dark-hover hover:bg-dark-surface transition-colors">
                    Cancel
                </a>
                <button type="submit" id="submit-btn"
                    class="inline-flex items-center justify-center px-4 h-10 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 transition-colors"
                    disabled>
                    Log Workout
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Exercise Template (hidden) -->
<template id="exercise-template">
    <div class="exercise-card bg-dark-hover rounded-lg p-4 relative" data-exercise-id="%EXERCISE_ID%">
        <button type="button" class="remove-exercise-btn absolute top-3 right-3 text-gray-400 hover:text-red-400">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-300 mb-1">Exercise Name</label>
            <div class="flex">
                <input type="text" class="exercise-name block w-full bg-dark-surface border-gray-700 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-100" 
                    placeholder="e.g., Bench Press" list="exercise-options" required>
                <button type="button" class="add-set-btn ml-2 px-3 py-1 bg-blue-600/30 hover:bg-blue-600/50 text-blue-300 rounded-md text-xs whitespace-nowrap">
                    <svg class="w-4 h-4 inline -mt-0.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add Set
                </button>
            </div>
            
            <!-- Exercise History and PRs -->
            <div class="exercise-history mt-3 text-xs space-y-2">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <div class="sets-container">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-gray-300">
                    <thead>
                        <tr>
                            <th class="px-2 py-2 text-left">Set</th>
                            <th class="px-2 py-2 text-left">Weight (kg)</th>
                            <th class="px-2 py-2 text-left">Reps</th>
                            <th class="px-2 py-2 text-left">Notes</th>
                            <th class="px-2 py-2 w-10"></th>
                        </tr>
                    </thead>
                    <tbody class="sets-table-body divide-y divide-gray-800">
                        <!-- Sets will be added here dynamically -->
                    </tbody>
                </table>
            </div>
            <div class="no-sets-message text-center py-3 text-gray-400 italic text-xs">
                No sets added yet. Click "Add Set" to add your first set.
            </div>
        </div>
    </div>
</template>

<!-- Set Row Template (hidden) -->
<template id="set-row-template">
    <tr class="set-row hover:bg-dark-surface" data-set-number="%SET_NUMBER%">
        <td class="px-2 py-2">
            <span class="set-number">%SET_NUMBER%</span>
        </td>
        <td class="px-2 py-2">
            <input type="number" class="set-weight w-20 bg-dark-surface border-gray-700 rounded focus:ring-blue-500 focus:border-blue-500 text-xs text-gray-100" 
                step="0.5" min="0" placeholder="Weight">
        </td>
        <td class="px-2 py-2">
            <input type="number" class="set-reps w-16 bg-dark-surface border-gray-700 rounded focus:ring-blue-500 focus:border-blue-500 text-xs text-gray-100" 
                min="0" placeholder="Reps">
        </td>
        <td class="px-2 py-2">
            <input type="text" class="set-notes w-full bg-dark-surface border-gray-700 rounded focus:ring-blue-500 focus:border-blue-500 text-xs text-gray-100" 
                placeholder="e.g., PR, Drop set, Failed">
        </td>
        <td class="px-2 py-2">
            <button type="button" class="remove-set-btn text-gray-400 hover:text-red-400">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </td>
    </tr>
</template>

<datalist id="exercise-options">
    {% for exercise in exercise_options %}
    <option value="{{ exercise }}">
    {% endfor %}
</datalist>

{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    let exerciseCounter = 0;
    const exercisesData = [];
    const exerciseHistory = {{ exercise_history|default({})|tojson|safe }};
    const workoutHistory = {{ workout_history|default({})|tojson|safe }};
    
    // DOM Elements
    const exercisesContainer = document.getElementById('exercises-container');
    const noExercisesMessage = document.getElementById('no-exercises-message');
    const addExerciseBtn = document.getElementById('add-exercise-btn');
    const exerciseTemplate = document.getElementById('exercise-template');
    const setRowTemplate = document.getElementById('set-row-template');
    const exercisesDataInput = document.getElementById('exercises-data');
    const submitBtn = document.getElementById('submit-btn');
    const workoutTypeSelect = document.getElementById('subtype');
    const workoutHistoryDiv = document.getElementById('workout-history');
    
    // Initialization
    document.addEventListener('DOMContentLoaded', () => {
        addExerciseBtn.addEventListener('click', addExercise);
        document.getElementById('strength-workout-form').addEventListener('submit', prepareFormSubmission);
        workoutTypeSelect.addEventListener('change', updateWorkoutHistory);
        updateWorkoutHistory(); // Show initial history
        updateSubmitButtonState();
        updatePreviousWorkout();
    });
    
    // Function to format date
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
        });
    }
    
    // Function to update workout history display
    function updateWorkoutHistory() {
        const selectedType = workoutTypeSelect.value;
        const history = workoutHistory[selectedType];
        
        if (!history) {
            workoutHistoryDiv.innerHTML = '<p class="text-gray-400 italic mt-2">No previous workouts of this type</p>';
            return;
        }
        
        let html = `
            <div class="bg-blue-900/20 p-2 rounded text-blue-200 mt-2">
                <div class="font-medium mb-1">Workout Stats:</div>
                <div class="grid grid-cols-2 gap-x-4 gap-y-1">
                    <div>Total Volume: ${Math.round(history.stats.total_volume)}kg</div>
                    <div>Max Duration: ${history.stats.max_duration}min</div>
                    <div>Avg Intensity: ${history.stats.avg_intensity}/10</div>
                </div>
            </div>
        `;
        
        if (history.stats.common_exercises.length > 0) {
            html += `
                <div class="mt-2">
                    <div class="text-gray-400 text-xs">Common exercises:</div>
                    <div class="flex flex-wrap gap-1 mt-1">
                        ${history.stats.common_exercises.map(([name, count]) => `
                            <span class="inline-flex items-center px-2 py-1 rounded-md bg-blue-900/20 text-blue-200">
                                ${name}
                            </span>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        if (history.last_workout) {
            const last = history.last_workout;
            html += `
                <div class="mt-2">
                    <div class="text-gray-400">Last workout (${formatDate(last.date)}):</div>
                    <div class="text-xs mt-1">
                        <div class="text-gray-200">${last.name}</div>
                        <div class="text-gray-400">
                            ${last.duration}min at intensity ${last.intensity}/10
                        </div>
                        <div class="mt-1">
                            ${last.exercises.map(ex => `
                                <div class="text-gray-300">
                                    ${ex.name}: ${ex.total_sets} sets
                                    ${ex.max_weight ? ` (max ${ex.max_weight}kg × ${ex.max_reps})` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        workoutHistoryDiv.innerHTML = html;
    }
    
    // Function to update exercise history display
    function updateExerciseHistory(exerciseCard, exerciseName) {
        const historyDiv = exerciseCard.querySelector('.exercise-history');
        const history = exerciseHistory[exerciseName];
        
        if (!history) {
            historyDiv.innerHTML = '<p class="text-gray-400 italic">No previous history</p>';
            return;
        }
        
        // Show PRs
        const prs = history.prs;
        let html = `
            <div class="bg-blue-900/20 p-2 rounded text-blue-200">
                <div class="font-medium">Personal Records:</div>
                <div class="grid grid-cols-3 gap-2 mt-1">
                    <div>Max Weight: ${prs.max_weight}kg</div>
                    <div>Max Reps: ${prs.max_reps}</div>
                    <div>Max Volume: ${prs.max_volume}kg</div>
                </div>
            </div>
        `;
        
        // Show last workout
        if (history.last_workout) {
            html += `
                <div class="text-gray-400 mt-2">
                    Last done: ${formatDate(history.last_workout)}
                </div>
            `;
        }
        
        // Show last workout sets
        if (history.history && history.history.length > 0) {
            const lastWorkout = history.history[0];
            html += `
                <div class="mt-2">
                    <div class="text-gray-400 mb-1">Last workout sets:</div>
                    <div class="space-y-1">
                        ${lastWorkout.sets.map(set => `
                            <div class="text-xs text-gray-300">
                                Set ${set.set_number}: ${set.weight}kg × ${set.reps} reps
                                ${set.notes ? `<span class="text-gray-400">(${set.notes})</span>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        historyDiv.innerHTML = html;
    }
    
    // Function to create a new exercise card
    function createExerciseCard() {
        const template = document.getElementById('exercise-template');
        const exerciseCard = template.content.cloneNode(true);
        
        // Set unique ID
        exerciseCard.querySelector('.exercise-card').dataset.exerciseId = `exercise-${exerciseCounter++}`;
        
        // Add event listeners
        const exerciseNameInput = exerciseCard.querySelector('.exercise-name');
        exerciseNameInput.addEventListener('change', function() {
            updateExerciseHistory(this.closest('.exercise-card'), this.value);
        });
        
        // Add remove button listener
        exerciseCard.querySelector('.remove-exercise-btn').addEventListener('click', function() {
            this.closest('.exercise-card').remove();
            updateExercisesData();
        });
        
        // Add set button listener
        exerciseCard.querySelector('.add-set-btn').addEventListener('click', function() {
            addSetToExercise(this.closest('.exercise-card'));
        });
        
        return exerciseCard;
    }
    
    // Add a new exercise card
    function addExercise() {
        exerciseCounter++;
        const exerciseId = exerciseCounter;
        
        // Clone template and replace placeholders
        const exerciseHTML = exerciseTemplate.innerHTML.replace(/%EXERCISE_ID%/g, exerciseId);
        
        // Create container and add HTML
        const exerciseElement = document.createElement('div');
        exerciseElement.innerHTML = exerciseHTML;
        exerciseElement.dataset.exerciseId = exerciseId;
        exerciseElement.className = 'exercise-card-container';
        
        // Add exercise to DOM
        exercisesContainer.appendChild(exerciseElement);
        noExercisesMessage.style.display = 'none';
        
        // Add event listeners
        const exerciseCard = exerciseElement.querySelector('.exercise-card');
        const removeExerciseBtn = exerciseCard.querySelector('.remove-exercise-btn');
        const addSetBtn = exerciseCard.querySelector('.add-set-btn');
        const exerciseNameInput = exerciseCard.querySelector('.exercise-name');
        
        removeExerciseBtn.addEventListener('click', () => removeExercise(exerciseId));
        addSetBtn.addEventListener('click', () => addSet(exerciseId));
        exerciseNameInput.addEventListener('change', updateExercisesData);
        
        // Add first set automatically
        addSet(exerciseId);
        
        // Add to data structure
        exercisesData.push({
            id: exerciseId,
            name: '',
            sets: []
        });
        
        updateExercisesData();
        updateSubmitButtonState();
    }
    
    // Remove an exercise card
    function removeExercise(exerciseId) {
        const exerciseElement = document.querySelector(`.exercise-card-container[data-exercise-id="${exerciseId}"]`);
        if (exerciseElement) {
            exerciseElement.remove();
            
            // Remove from data structure
            const index = exercisesData.findIndex(ex => ex.id === exerciseId);
            if (index !== -1) {
                exercisesData.splice(index, 1);
                updateExercisesData();
            }
            
            // Show message if no exercises remain
            if (exercisesContainer.querySelectorAll('.exercise-card-container').length === 0) {
                noExercisesMessage.style.display = 'block';
            }
            
            updateSubmitButtonState();
        }
    }
    
    // Add a set to an exercise
    function addSet(exerciseId) {
        const exerciseCard = document.querySelector(`.exercise-card[data-exercise-id="${exerciseId}"]`);
        const setsTableBody = exerciseCard.querySelector('.sets-table-body');
        const noSetsMessage = exerciseCard.querySelector('.no-sets-message');
        
        // Count existing sets to determine the new set number
        const existingSets = setsTableBody.querySelectorAll('.set-row');
        const setNumber = existingSets.length + 1;
        
        // Clone template and replace placeholders
        const setRowHTML = setRowTemplate.innerHTML.replace(/%SET_NUMBER%/g, setNumber);
        
        // Create row and add HTML
        const setRow = document.createElement('tr');
        setRow.innerHTML = setRowHTML;
        setRow.classList.add('set-row');
        setRow.dataset.setNumber = setNumber;
        
        // Add set to DOM
        setsTableBody.appendChild(setRow);
        noSetsMessage.style.display = 'none';
        
        // Add event listeners
        const removeSetBtn = setRow.querySelector('.remove-set-btn');
        const weightInput = setRow.querySelector('.set-weight');
        const repsInput = setRow.querySelector('.set-reps');
        const notesInput = setRow.querySelector('.set-notes');
        
        removeSetBtn.addEventListener('click', () => removeSet(exerciseId, setNumber));
        weightInput.addEventListener('change', updateExercisesData);
        repsInput.addEventListener('change', updateExercisesData);
        notesInput.addEventListener('change', updateExercisesData);
        
        // Add to data structure
        const exerciseIndex = exercisesData.findIndex(ex => ex.id === exerciseId);
        if (exerciseIndex !== -1) {
            exercisesData[exerciseIndex].sets.push({
                setNumber: setNumber,
                weight: '',
                reps: '',
                notes: ''
            });
        }
        
        updateExercisesData();
    }
    
    // Remove a set from an exercise
    function removeSet(exerciseId, setNumber) {
        const exerciseCard = document.querySelector(`.exercise-card[data-exercise-id="${exerciseId}"]`);
        const setRow = exerciseCard.querySelector(`.set-row[data-set-number="${setNumber}"]`);
        
        if (setRow) {
            setRow.remove();
            
            // Remove from data structure
            const exerciseIndex = exercisesData.findIndex(ex => ex.id === exerciseId);
            if (exerciseIndex !== -1) {
                const setIndex = exercisesData[exerciseIndex].sets.findIndex(set => set.setNumber === parseInt(setNumber));
                if (setIndex !== -1) {
                    exercisesData[exerciseIndex].sets.splice(setIndex, 1);
                }
            }
            
            // Renumber remaining sets
            const remainingSets = exerciseCard.querySelectorAll('.set-row');
            remainingSets.forEach((row, index) => {
                const newSetNumber = index + 1;
                row.dataset.setNumber = newSetNumber;
                row.querySelector('.set-number').textContent = newSetNumber;
                
                // Update set number in data structure
                if (exerciseIndex !== -1 && index < exercisesData[exerciseIndex].sets.length) {
                    exercisesData[exerciseIndex].sets[index].setNumber = newSetNumber;
                }
            });
            
            // Show message if no sets remain
            if (remainingSets.length === 0) {
                exerciseCard.querySelector('.no-sets-message').style.display = 'block';
            }
            
            updateExercisesData();
        }
    }
    
    // Update the data structure with current values
    function updateExercisesData() {
        const exerciseCards = document.querySelectorAll('.exercise-card');
        
        exerciseCards.forEach(card => {
            const exerciseId = parseInt(card.dataset.exerciseId);
            const exerciseName = card.querySelector('.exercise-name').value;
            const exerciseIndex = exercisesData.findIndex(ex => ex.id === exerciseId);
            
            if (exerciseIndex !== -1) {
                exercisesData[exerciseIndex].name = exerciseName;
                exercisesData[exerciseIndex].sets = [];  // Reset sets array
                
                // Update set data
                const setRows = Array.from(card.querySelectorAll('.set-row'));
                // Sort by set number to ensure correct order
                setRows.sort((a, b) => parseInt(a.dataset.setNumber) - parseInt(b.dataset.setNumber));
                
                // Rebuild sets array with sequential numbers starting at 1
                setRows.forEach((row, index) => {
                    const setNumber = index + 1;  // Ensure sequential numbering
                    const weight = row.querySelector('.set-weight').value;
                    const reps = row.querySelector('.set-reps').value;
                    const notes = row.querySelector('.set-notes').value;
                    
                    exercisesData[exerciseIndex].sets.push({
                        setNumber: setNumber,
                        weight: weight,
                        reps: reps,
                        notes: notes
                    });
                    
                    // Update the displayed set number
                    row.dataset.setNumber = setNumber;
                    row.querySelector('.set-number').textContent = setNumber;
                });
            }
        });
        
        // Update hidden input with JSON data
        const cleanData = exercisesData.map(exercise => ({
            name: exercise.name,
            sets: exercise.sets.map(set => ({
                set_number: set.setNumber,  // Ensure set_number is included
                reps: set.reps,
                weight: set.weight,
                notes: set.notes
            }))
        }));
        
        exercisesDataInput.value = JSON.stringify(cleanData);
        updateSubmitButtonState();
    }
    
    // Enable/disable submit button based on form validity
    function updateSubmitButtonState() {
        const workoutName = document.getElementById('name').value;
        const duration = document.getElementById('duration').value;
        const hasExercises = exercisesData.length > 0;
        const hasValidExercises = exercisesData.every(ex => ex.name.trim() !== '');
        
        if (workoutName && duration && hasExercises && hasValidExercises) {
            submitBtn.disabled = false;
        } else {
            submitBtn.disabled = true;
        }
    }
    
    // Prepare form data before submission
    function prepareFormSubmission(e) {
        updateExercisesData();
        
        // Final validation check
        const workoutName = document.getElementById('name').value;
        const duration = document.getElementById('duration').value;
        const hasExercises = exercisesData.length > 0;
        const hasValidExercises = exercisesData.every(ex => ex.name.trim() !== '');
        
        if (!workoutName || !duration || !hasExercises || !hasValidExercises) {
            e.preventDefault();
            alert('Please fill out all required fields and add at least one exercise.');
        }
    }
    
    // Function to update previous workout info
    function updatePreviousWorkout() {
        const workoutType = document.getElementById('subtype').value;
        const history = workoutHistory[workoutType];
        
        const noPrevWorkout = document.getElementById('no-previous-workout');
        const prevWorkoutDetails = document.getElementById('previous-workout-details');
        
        if (!history || !history.last_workout) {
            noPrevWorkout.classList.remove('hidden');
            prevWorkoutDetails.classList.add('hidden');
            return;
        }
        
        const workout = history.last_workout;
        
        // Update the workout details
        document.getElementById('prev-workout-date').textContent = formatDate(workout.date);
        document.getElementById('prev-workout-duration').textContent = `${workout.duration} min`;
        document.getElementById('prev-workout-intensity').textContent = `${workout.intensity}/10`;
        
        // Update exercises
        const exercisesList = document.getElementById('prev-workout-exercises');
        exercisesList.innerHTML = '';
        
        workout.exercises.forEach(exercise => {
            const li = document.createElement('li');
            li.className = 'text-gray-200';
            li.textContent = `${exercise.name} - ${exercise.total_sets} sets`;
            if (exercise.max_weight) {
                li.textContent += ` (max ${exercise.max_weight}kg × ${exercise.max_reps})`;
            }
            exercisesList.appendChild(li);
        });
        
        noPrevWorkout.classList.add('hidden');
        prevWorkoutDetails.classList.remove('hidden');
    }
    
    // Add event listener for workout type change
    document.getElementById('subtype').addEventListener('change', function() {
        updatePreviousWorkout();
    });
    
    // Call on page load
    document.addEventListener('DOMContentLoaded', function() {
        updatePreviousWorkout();
    });
</script>
{% endblock %} 